{% extends "base.html" %}
{% load static %}

{% block title %}Radicados enviados{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/radicacion.css' %}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
{% endblock %}

{% block content %}
<div class="container-form">
  <div class="card shadow-lg">
    <div class="card-header">
      <h4><i class="fas fa-envelope-open-text"></i> Registrar radicado enviado</h4>
    </div>
    <div class="card-body">

      <!-- Mensajes de error -->
      {% if form.errors %}
      <div class="alert alert-danger">
        <strong><i class="fas fa-exclamation-circle"></i> Por favor, corrige los siguientes errores:</strong>
        <ul>
          {% for field, errors in form.errors.items %}
          <li><strong>{{ field }}:</strong> {{ errors.0 }}</li>
          {% endfor %}
        </ul>
      </div>
      {% endif %}

      {{ form.media }}
      <form method="post" id="solicitud-data-form" novalidate>
        {% csrf_token %}

        <!-- ========== SECCIÓN 1: INFORMACIÓN DE INGRESO ========== -->
        <div class="form-section">
          <div class="form-section-title">
            <i class="fas fa-inbox"></i> Información de Envio
          </div>

          <div class="form-row">
            <div class="form-group">
              <label class="form-label" for="{{ form.medio_envio.id_for_label }}">
                <i class="fas fa-map-pin"></i> {{ form.medio_envio.label }}
              </label>
              {{ form.medio_envio }}
            </div>

            <div class="form-group">
              <label class="form-label" for="{{ form.tipo_comunicacion.id_for_label }}">
                <i class="fas fa-envelope"></i> {{ form.tipo_comunicacion.label }}
              </label>
              {{ form.tipo_comunicacion }}
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label class="form-label" for="{{ form.tipo_documento.id_for_label }}">
                <i class="fas fa-file"></i> {{ form.tipo_documento.label }}
              </label>
              {{ form.tipo_documento }}
            </div>

            <div class="form-group">
              <label class="form-label" for="{{ form.num_rad_llegada.id_for_label }}">
                <i class="fas fa-barcode"></i> {{ form.num_rad_llegada.label }}
              </label>
              {{ form.num_rad_llegada }}
            </div>
          </div>
        </div>

        <!-- ========== SECCIÓN 2: DATOS DEL REMITENTE ========== -->
        <div class="form-section">
          <div class="form-section-title">
            <i class="fas fa-building"></i> Datos del Remitente
          </div>

          <div class="form-group form-row full">
            <label class="form-label" for="{{ form.entidad.id_for_label }}">
              <i class="fas fa-bank"></i> {{ form.entidad.label }}
              <button type="button" class="btn btn-sm btn-primary ms-2" id="btn-crear-entidad" data-bs-toggle="modal" data-bs-target="#modalCrearEntidad">
                <i class="fas fa-plus"></i> Crear
              </button>
            </label>
            {{ form.entidad }}
          </div>

          <div class="form-group form-row full">
            <label class="form-label" for="{{ form.asunto.id_for_label }}">
              <i class="fas fa-sticky-note"></i> {{ form.asunto.label }}
            </label>
            {{ form.asunto }}
          </div>

          <div class="form-group">
            <label class="form-label" for="{{ form.num_rad_interno.id_for_label }}">
              <i class="fas fa-bank"></i> {{ form.num_rad_interno.label }}
            </label>
            {{ form.num_rad_interno }}
          </div>

          <div class="form-group">
            <label class="form-label" for="{{ form.num_radicado_interno_2025.id_for_label }}">
              <i class="fas fa-bank"></i> {{ form.num_radicado_interno_2025.label }}
            </label>
            {{ form.num_radicado_interno_2025 }}
          </div>

          <div class="form-group form-row full">
            <label class="form-label" for="{{ form.anexos.id_for_label }}">
              <i class="fas fa-paperclip"></i> {{ form.anexos.label }}
            </label>
            {{ form.anexos }}
          </div>

          <div class="form-group form-row full">
            <label class="form-label" for="{{ form.observaciones.id_for_label }}">
              <i class="fas fa-comment"></i> {{ form.observaciones.label }}
            </label>
            {{ form.observaciones }}
          </div>
        </div>

        <!-- ========== SECCIÓN 3: ASIGNACIÓN Y RESPUESTA ========== -->
        <div class="form-section">
          <div class="form-section-title">
            <i class="fas fa-tasks"></i> Asignación y Respuesta
          </div>

          <div class="form-row">
            <div class="form-group">
              <label class="form-label" for="{{ form.enviado_por.id_for_label }}">
                <i class="fas fa-user-tie"></i> {{ form.enviado_por.label }}
              </label>
              <div class="input-group">
                {{ form.enviado_por }}
                <span class="input-group-text">
                  <i class="fas fa-spinner spinner" id="spinner-enviado_por" style="display: none;"></i>
                </span>
              </div>
              <div class="info-oficina-cargada" id="info-oficina-cargada"></div>
            </div>

            <div class="form-group">
              <label class="form-label" for="{{ form.oficina.id_for_label }}">
                <i class="fas fa-map-location-dot"></i> {{ form.oficina.label }}
              </label>
              <div class="input-group">
                {{ form.oficina }}
                <span class="input-group-text">
                  <i class="fas fa-check-circle text-success" id="check-oficina" style="display: none;"></i>
                </span>
              </div>
              <small class="form-text">
                <i class="fas fa-info-circle"></i> Se carga automáticamente según el responsable seleccionado
              </small>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label class="form-label" for="{{ form.requiere_respuesta.id_for_label }}">
                <i class="fas fa-reply"></i> {{ form.requiere_respuesta.label }}
              </label>
              {{ form.requiere_respuesta }}
            </div>

            <div class="form-group">
              <label class="form-label" for="{{ form.tiempo_respuesta.id_for_label }}">
                <i class="fas fa-hourglass-end"></i> {{ form.tiempo_respuesta.label }}
              </label>
              <div class="input-group">
                {{ form.tiempo_respuesta }}
                <span class="input-group-text">
                  <i class="fas fa-spinner spinner" id="spinner-tiempo" style="display: none;"></i>
                </span>
              </div>
              <small class="form-text">
                <i class="fas fa-info-circle"></i> Días hábiles (sin sábados, domingos ni festivos)
              </small>
              <div class="info-dias-habiles" id="info-dias-habiles"></div>
            </div>
          </div>

          <div class="form-group form-row full">
            <label class="form-label" for="{{ form.fecha_maxima_respuesta.id_for_label }}">
              <i class="fas fa-calendar-check"></i> {{ form.fecha_maxima_respuesta.label }}
            </label>
            <div class="input-group">
              {{ form.fecha_maxima_respuesta }}
              <span class="input-group-text">
                <i class="fas fa-check-circle text-success" id="check-fecha" style="display: none;"></i>
              </span>
            </div>
            <small class="form-text">
              <i class="fas fa-info-circle"></i> Se calcula automáticamente basada en los días hábiles ingresados
            </small>
          </div>
        </div>

        <!-- ========== SECCIÓN 4: CONTROL DE RESPUESTA ========== -->
        <div class="form-section">
          <div class="form-section-title">
            <i class="fas fa-check-double"></i> Control de Respuesta
          </div>

          <div class="form-row">
            <div class="form-group">
              <label class="form-label" for="{{ form.fecha_respuesta.id_for_label }}">
                <i class="fas fa-calendar"></i> {{ form.fecha_respuesta.label }}
              </label>
              {{ form.fecha_respuesta }}                     
            </div>

            <div class="form-group">
              <label class="form-label" for="{{ form.recibido.id_for_label }}">
                <i class="fas fa-share"></i> {{ form.recibido.label }}
              </label>
              {{ form.recibido }}
            </div>
          </div>
        </div>

        <!-- ========== BOTONES DE ACCIÓN ========== -->
        <input type="hidden" name="radicador" value="{{ request.user.id }}">

        <div class="row justify-content-center mt-4 g-3">
          <div class="col-md-4 d-grid">
            <button type="submit" class="btn btn-success btn-lg">
              <i class="fas fa-save"></i> Guardar Registro
            </button>
          </div>

          <div class="col-md-4 d-grid">
            <a href="{% url 'radicados_enviados' %}" class="btn btn-secondary btn-lg">
              <i class="fas fa-arrow-left"></i> Volver
            </a>
          </div>
        </div>


        <!-- Modal para crear entidad -->
        <div class="modal fade" id="modalCrearEntidad" tabindex="-1" aria-hidden="true">
          <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-building"></i> Crear Nueva Entidad</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <form id="form-crear-entidad">
                  {% csrf_token %}
                  <div class="mb-3">
                    <label for="nombre-entidad" class="form-label">Nombre de la Entidad</label>
                    <input type="text" class="form-control" id="nombre-entidad" name="nombre" required>
                  </div>
                  <div id="alert-crear-entidad"></div>
                </form>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-success" id="btn-guardar-entidad">
                  <i class="fas fa-save"></i> Guardar Entidad
                </button>
              </div>
            </div>
          </div>
        </div>

      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>

<script>
  $(document).ready(function () {
    // Activar Select2 en los dropdowns
    $('select').select2({
      width: '100%',
      language: 'es'
    });

    // ============================================================
    // CARGAR OFICINA AUTOMÁTICAMENTE SEGÚN RESPONSABLE SELECCIONADO
    // ============================================================

    const responsableSelect = $('#id_enviado_por');
    const oficinaSelect = $('#id_oficina');
    const spinnerResponsable = $('#spinner-responsable');
    const checkOficina = $('#check-oficina');
    const infoOficina = $('#info-oficina-cargada');

    function cargarOficinaResponsable() {
      const responsableId = responsableSelect.val();

      if (!responsableId) {
        oficinaSelect.val(null).trigger('change');
        checkOficina.hide();
        infoOficina.removeClass('show').html('');
        return;
      }

      spinnerResponsable.show();

      $.ajax({
        url: '{% url "get_oficina_responsable" %}',
        type: 'GET',
        data: { responsable_id: responsableId },
        success: function (response) {
          if (response.exito) {
            oficinaSelect.val(response.oficina_id).trigger('change');
            oficinaSelect.addClass('oficina-cargada');
            infoOficina.html(
              `<strong><i class="fas fa-check-circle"></i> Oficina cargada automáticamente:</strong> ${response.oficina_nombre}`
            ).addClass('show');
            checkOficina.show();
          } else {
            alert('❌ Error al cargar la oficina: ' + response.error);
            oficinaSelect.val(null).trigger('change');
          }
        },
        error: function () {
          alert('❌ Error en la conexión.');
          oficinaSelect.val(null).trigger('change');
        },
        complete: function () {
          spinnerResponsable.hide();
        }
      });
    }

    responsableSelect.on('change', function () {
      cargarOficinaResponsable();
    });

    // ============================================================
    // CALCULAR FECHA DE RESPUESTA
    // ============================================================

    const tiempoRespuestaInput = $('#id_tiempo_respuesta');
    const fechaMaximaInput = $('#id_fecha_maxima_respuesta');
    const spinnerTiempo = $('#spinner-tiempo');
    const checkFecha = $('#check-fecha');
    const infoTiempo = $('#info-dias-habiles');

    function calcularFechaRespuesta() {
      const dias = parseInt(tiempoRespuestaInput.val());

      if (isNaN(dias) || dias === '') {
        fechaMaximaInput.val('');
        checkFecha.hide();
        infoTiempo.removeClass('show').html('');
        return;
      }

      if (dias < 0) {
        alert('⚠️ Los días no pueden ser negativos');
        tiempoRespuestaInput.val('');
        return;
      }

      spinnerTiempo.show();

      $.ajax({
        url: '{% url "calcular_fecha_respuesta" %}',
        type: 'GET',
        data: { dias: dias },
        success: function (response) {
          if (response.exito) {
            fechaMaximaInput.val(response.fecha_maxima);
            fechaMaximaInput.addClass('fecha-calculada');

            const fechaFormato = new Date(response.fecha_maxima).toLocaleDateString('es-CO', {
              weekday: 'long',
              year: 'numeric',
              month: 'long',
              day: 'numeric'
            });


            checkFecha.show();
          } else {
            alert('❌ Error: ' + response.error);
            fechaMaximaInput.val('');
          }
        },
        error: function () {
          alert('❌ Error en la conexión.');
          fechaMaximaInput.val('');
        },
        complete: function () {
          spinnerTiempo.hide();
        }
      });
    }

    tiempoRespuestaInput.on('change keyup', function () {
      calcularFechaRespuesta();
    });

    tiempoRespuestaInput.on('keypress', function (e) {
      const char = String.fromCharCode(e.which);
      if (!/[0-9]/.test(char)) {
        e.preventDefault();
      }
    });

    fechaMaximaInput.on('focus', function () {
      $(this).blur();
    });

    // ============================================================
    // CREAR ENTIDAD EN MODAL
    // ============================================================

   
    const btnGuardarEntidad = $('#btn-guardar-entidad');
    const formCrearEntidad = $('#form-crear-entidad');
    const alertCrearEntidad = $('#alert-crear-entidad');
    const modalElement = document.getElementById('modalCrearEntidad');
    // obtener o crear la misma instancia que usa el atributo data-bs-toggle
    const modalCrearEntidad = (bootstrap.Modal.getOrCreateInstance)
      ? bootstrap.Modal.getOrCreateInstance(modalElement)
      : (bootstrap.Modal.getInstance(modalElement) || new bootstrap.Modal(modalElement));
    const entidadSelect = $('#id_entidad');

    // variable para mantener la petición activa y permitir abortarla si se cierra el modal
    let crearEntidadXhr = null;

    // limpiar/rehabilitar estado cuando el modal quede oculto
    modalElement.addEventListener('hidden.bs.modal', function () {
      if (crearEntidadXhr && crearEntidadXhr.readyState !== 4) {
        try { crearEntidadXhr.abort(); } catch (e) {}
      }
      if (formCrearEntidad && formCrearEntidad[0]) formCrearEntidad[0].reset();
      alertCrearEntidad.html('');
      btnGuardarEntidad.prop('disabled', false).html('<i class="fas fa-save"></i> Guardar Entidad');
    });

    btnGuardarEntidad.on('click', function () {
      const nombre = $('#nombre-entidad').val().trim();

      if (!nombre) {
        mostrarAlerta('Por favor ingresa el nombre de la entidad', 'danger');
        return;
      }

      btnGuardarEntidad.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Guardando...');

      crearEntidadXhr = $.ajax({
        url: '{% url "crear_entidad_ajax" %}',
        type: 'POST',
        data: {
          csrfmiddlewaretoken: $('[name=csrfmiddlewaretoken]').val(),
          nombre: nombre
        },
        success: function (response) {
          if (response.exito) {
            mostrarAlerta('✅ Entidad creada correctamente', 'success');

            // Actualizar el select con la nueva entidad
            entidadSelect.append(new Option(response.nombre, response.id, false, true));
            entidadSelect.trigger('change');

            // Limpiar formulario
            if (formCrearEntidad && formCrearEntidad[0]) formCrearEntidad[0].reset();

            // Cerrar modal después de 1.2 segundos
            setTimeout(() => {
              // usar la instancia correcta para ocultar
              try { modalCrearEntidad.hide(); } catch (e) { /* fallback - nada */ }
              alertCrearEntidad.html('');
              btnGuardarEntidad.prop('disabled', false).html('<i class="fas fa-save"></i> Guardar Entidad');
            }, 1200);
          } else {
            mostrarAlerta('❌ Error: ' + response.error, 'danger');
            btnGuardarEntidad.prop('disabled', false).html('<i class="fas fa-save"></i> Guardar Entidad');
          }
        },
        error: function (jqXHR, textStatus) {
          if (textStatus === 'abort') {
            // petición abortada por cierre del modal — no mostrar error
            return;
          }
          mostrarAlerta('❌ Error en la conexión', 'danger');
          btnGuardarEntidad.prop('disabled', false).html('<i class="fas fa-save"></i> Guardar Entidad');
        },
        complete: function () {
          crearEntidadXhr = null;
        }
      });
    });

    formCrearEntidad.on('keypress', function (e) {
      if (e.keyCode === 13) {
        e.preventDefault();
        btnGuardarEntidad.click();
      }
    });

    function mostrarAlerta(mensaje, tipo) {
      alertCrearEntidad.html(
        `<div class="alert alert-${tipo} alert-dismissible fade show" role="alert">
          ${mensaje}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>`
      );
    }
  });
</script>
{% endblock %}